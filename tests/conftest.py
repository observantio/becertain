"""
Test Suite Conftest

Copyright (c) 2026 Stefan Kumarasinghe

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
"""

import os
import sys
import pytest


ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if ROOT not in sys.path:
    sys.path.insert(0, ROOT)

from store.client import _fallback, _redis_client


@pytest.fixture(autouse=True)
def clear_fallback(monkeypatch):
    """Wipe the in-memory redis fallback before and after each test and override
    the redis helpers so they always operate on the in-memory store.
    """
    
    _fallback.clear()
    global _redis_client
    _redis_client = None

    
    import store.client as client

    async def fake_get(key: str):
        return _fallback.get(key)

    async def fake_set(key: str, value: str, ttl=None):
        _fallback[key] = value

    async def fake_delete(key: str):
        _fallback.pop(key, None)

    monkeypatch.setattr(client, "redis_get", fake_get)
    monkeypatch.setattr(client, "redis_set", fake_set)
    monkeypatch.setattr(client, "redis_delete", fake_delete)

    
    import store.weights as wstore
    import store.baseline as bstore
    import store.granger as gstore
    import store.events as estore
    for mod in (wstore, bstore, gstore, estore):
        for name in ("redis_get", "redis_set", "redis_delete"):
            if hasattr(mod, name):
                monkeypatch.setattr(mod, name, locals()[f"fake_{name.split('_')[1]}"])

    yield

    _fallback.clear()
    _redis_client = None








def pytest_ignore_collect(path, config):
    text = str(path)
    if os.path.sep + 'engine' + os.path.sep in text:
        return True

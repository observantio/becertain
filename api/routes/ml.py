"""
ML routes for adaptive signal weighting based on user feedback.

Copyright (c) 2026 Stefan Kumarasinghe
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
"""

from __future__ import annotations

from typing import Any, Dict

from fastapi import APIRouter, HTTPException

from engine.enums import Signal
from api.routes.exception import handle_exceptions
from services.security_service import get_context_tenant
from engine.registry import get_registry
from api.routes.common import safe_call

router = APIRouter(tags=["ML"])


@router.post("/ml/weights/feedback", summary="Submit signal correctness feedback")
@handle_exceptions
async def signal_feedback(tenant_id: str, signal: str, was_correct: bool) -> Dict[str, Any]:
    tenant_id = get_context_tenant(tenant_id)
    try:
        sig = Signal(signal)
    except ValueError:
        raise HTTPException(
            status_code=400,
            detail=f"Unknown signal '{signal}'. Valid values: {[s.value for s in Signal]}",
        )
    state = await safe_call(get_registry().update_weight(tenant_id, sig, was_correct), 500)
    # weights_serializable always uses plain string keys suitable for JSON output
    return {"updated_weights": state.weights_serializable, "update_count": state.update_count}


@router.get("/ml/weights", summary="Current adaptive signal weights for a tenant")
@handle_exceptions
async def get_signal_weights(tenant_id: str) -> Dict[str, Any]:
    tenant_id = get_context_tenant(tenant_id)
    state = await safe_call(get_registry().get_state(tenant_id), 500)
    return {"weights": state.weights_serializable, "update_count": state.update_count}


@router.post("/ml/weights/reset", summary="Reset adaptive weights to defaults for a tenant")
@handle_exceptions
async def reset_signal_weights(tenant_id: str) -> Dict[str, Any]:
    tenant_id = get_context_tenant(tenant_id)
    state = await safe_call(get_registry().reset_weights(tenant_id), 500)
    return {"weights": state.weights_serializable, "update_count": state.update_count}
